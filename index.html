<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>VGEN2 - 1080p Wipe Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }
    @font-face {
      font-family: 'DMSerifCustomBold';
      src: url('./fonts/DMSerifDisplay-Bold.ttf') format('truetype');
      font-weight: 700;
    }
    @font-face {
      font-family: 'PlusJakartaCustom';
      src: url('./fonts/PlusJakartaSans-Bold.woff2') format('woff2');
      font-weight: 700;
    }
    body {
      margin: 0; padding: 12px; display: flex; gap: 16px;
      background: #020617; color: #e5e7eb;
      font-family: 'PlusJakartaCustom', sans-serif;
    }
    .panel { background: #020617; padding: 16px; border-radius: 14px; border: 1px solid #1f2937; }
    .left { width: 380px; flex-shrink: 0; display: flex; flex-direction: column; gap: 12px; }
    .right { flex: 1; display: flex; justify-content: center; align-items: center; }
    textarea {
      width: 100%; min-height: 40px; background: #020617; color: #e5e7eb;
      border-radius: 10px; border: 1px solid #334155; padding: 10px; font-family: inherit;
    }
    canvas {
      background: #808080; border-radius: 18px; border: 1px solid #4b5563;
      max-height: 92vh; max-width: 100%; object-fit: contain;
    }
    button { padding: 10px; border-radius: 99px; border: none; cursor: pointer; font-weight: 700; }
    #renderBtn { background: #2563eb; color: #fff; }
    #previewBtn { background: #111827; color: #e5e7eb; border: 1px solid #1f2937; }
  </style>
</head>
<body>

<div class="panel left">
  <textarea id="upper">The Brief</textarea>
  <textarea id="title">The Psychology of Money</textarea>
  <textarea id="subtitle">How to think about wealth</textarea>
  <textarea id="body" style="min-height: 200px;">Investing is not about being [[smart]], it's about being [[disciplined]].</textarea>
  <button id="previewBtn">Preview</button>
  <button id="renderBtn">Render (1080p)</button>
  <div id="status" style="text-align:center; font-size:12px; color:#9ca3af;">Status: Idle</div>
  <div id="download" style="text-align:center;"></div>
</div>

<div class="panel right">
  <canvas id="canvas"></canvas>
</div>

<script>
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const LOGICAL_WIDTH = 1080;
  const LOGICAL_HEIGHT = 1920;

  canvas.width = LOGICAL_WIDTH;
  canvas.height = LOGICAL_HEIGHT;

  const upperEl = document.getElementById('upper');
  const titleEl = document.getElementById('title');
  const subtitleEl = document.getElementById('subtitle');
  const bodyEl = document.getElementById('body');
  const statusEl = document.getElementById('status');
  const downloadEl = document.getElementById('download');

  let animating = false, recording = false, animStart = null;
  let targetDuration = 10, bodyPages = [], pageDurations = [];
  let titleCanvas = null, titleTextureReady = false;

  // Timing
  const TITLE_PRE_HOLD = 0.3, TITLE_WIPE = 0.8, TITLE_STATIC = 2.0;
  const BODY_WIPE = 0.8, PAGE_GAP = 0.6; 
  const READING_WORDS_PER_SEC = 2.5;

  function wrapText(text, maxWidth, fontSpec) {
    ctx.font = fontSpec;
    const lines = [];
    text.split(/\n/).forEach(p => {
      const words = p.trim().split(/\s+/);
      if (!words[0]) return;
      let line = words[0];
      for (let i = 1; i < words.length; i++) {
        if (ctx.measureText(line + " " + words[i]).width < maxWidth) {
          line += " " + words[i];
        } else { lines.push(line); line = words[i]; }
      }
      lines.push(line);
    });
    return lines;
  }

  function tokenize(text) {
    let tokens = [], buf = '', hi = false, i = 0;
    while (i < text.length) {
      if (!hi && text.startsWith('[[', i)) { flush(); hi = true; i += 2; }
      else if (hi && text.startsWith(']]', i)) { flush(); hi = false; i += 2; }
      else { buf += text[i]; if (text[i] === ' ' && !hi) flush(); i++; }
    }
    function flush() { if (buf) { tokens.push({ text: buf, highlight: hi }); buf = ''; } }
    flush(); return tokens;
  }

  function preparePages() {
    const margin = 110;
    const maxWidth = 1080 - (margin * 2);
    const bodyFont = "700 48px 'PlusJakartaCustom'"; // Font isi dikecilkan (dari 58 ke 48)
    const lines = wrapText(bodyEl.value, maxWidth, bodyFont);
    bodyPages = []; pageDurations = [];
    let cur = [];
    for (let i = 0; i < lines.length; i++) {
      cur.push(lines[i]);
      if (cur.length === 10 || i === lines.length - 1) {
        bodyPages.push(cur);
        const words = cur.join(' ').split(' ').length;
        pageDurations.push(Math.max(2.5, words / READING_WORDS_PER_SEC));
        cur = [];
      }
    }
    targetDuration = (TITLE_PRE_HOLD + TITLE_WIPE + TITLE_STATIC) + 
                     pageDurations.reduce((a, b) => a + b, 0) + (bodyPages.length * PAGE_GAP);
  }

  function rebuildTitleTexture() {
    titleCanvas = document.createElement('canvas');
    titleCanvas.width = 1080; titleCanvas.height = 1920;
    const tCtx = titleCanvas.getContext('2d');
    const margin = 110, maxWidth = 1080 - 220;
    let y = 1220;
    tCtx.fillStyle = 'white'; tCtx.textAlign = 'left';

    // Upper: Tidak kapital otomatis
    if (upperEl.value) {
      tCtx.font = "700 34px 'PlusJakartaCustom'";
      wrapText(upperEl.value, maxWidth, tCtx.font).forEach(l => { tCtx.fillText(l, margin, y); y += 45; });
      y += 40; 
    }
    // Title
    tCtx.font = "700 96px 'DMSerifCustomBold'";
    wrapText(titleEl.value, maxWidth, tCtx.font).forEach(l => { tCtx.fillText(l, margin, y); y += 105; });
    
    y -= 10; // Merapatkan jarak subjudul (sebelumnya +25, sekarang dikurangi)

    // Subtitle
    if (subtitleEl.value) {
      tCtx.font = "700 34px 'PlusJakartaCustom'";
      wrapText(subtitleEl.value, maxWidth, tCtx.font).forEach(l => { tCtx.fillText(l, margin, y); y += 45; });
    }
    titleTextureReady = true;
  }

  function draw(t) {
    ctx.fillStyle = '#808080'; ctx.fillRect(0, 0, 1080, 1920);
    const titleEnd = TITLE_PRE_HOLD + TITLE_WIPE + TITLE_STATIC;

    if (t < titleEnd) {
      if (!titleTextureReady) rebuildTitleTexture();
      ctx.drawImage(titleCanvas, 0, 0);
      if (t > TITLE_PRE_HOLD && t < TITLE_PRE_HOLD + TITLE_WIPE) {
        let p = (t - TITLE_PRE_HOLD) / TITLE_WIPE;
        ctx.fillStyle = '#808080'; ctx.fillRect(110 + (860 * p), 0, 1080, 1920);
      }
    } else {
      let local = t - titleEnd;
      for (let i = 0; i < bodyPages.length; i++) {
        let d = pageDurations[i] + PAGE_GAP;
        if (local < d) { drawBodyPage(bodyPages[i], local); break; }
        local -= d;
      }
    }
  }

  function drawBodyPage(lines, localT) {
    const margin = 110; let startY = 1300;
    const tokens = tokenize(lines.join(' '));
    ctx.font = "700 48px 'PlusJakartaCustom'";
    ctx.textBaseline = 'top';

    // Animasi Wipe untuk Isi (Meniru Judul)
    let curX = margin, curY = startY;
    const maxWidth = 1080 - (margin * 2);

    tokens.forEach((tok) => {
      tok.text.split(/(\s+)/).forEach(word => {
        let w = ctx.measureText(word).width;
        if (curX + w > 1080 - margin && word.trim()) { curX = margin; curY += 70; }

        // Progress Wipe Per Halaman
        let progress = Math.min(1, localT / BODY_WIPE);
        let wipeBorder = margin + (860 * progress);

        if (curX < wipeBorder) {
          // Highlight Kotak Dinamis
          if (tok.highlight) {
            ctx.fillStyle = '#38bdf8';
            ctx.fillRect(curX - 4, curY, w + 8, 60); // Kotak Biru
            ctx.fillStyle = 'white'; // Teks di atas kotak biru jadi putih
          } else {
            ctx.fillStyle = 'white';
          }
          ctx.fillText(word, curX, curY);
        }
        curX += w;
      });
    });
  }

  function animate(ts) {
    if (!animating && !recording) return;
    if (!animStart) animStart = ts;
    draw((ts - animStart) / 1000);
    if ((ts - animStart) / 1000 < targetDuration) requestAnimationFrame(animate);
    else { animating = false; statusEl.textContent = "Status: Idle"; }
  }

  document.getElementById('previewBtn').onclick = () => {
    preparePages(); titleTextureReady = false; animating = true; animStart = null;
    requestAnimationFrame(animate);
  };

  document.getElementById('renderBtn').onclick = () => {
    preparePages(); titleTextureReady = false; recording = true; animStart = null;
    const stream = canvas.captureStream(30);
    const recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9', videoBitsPerSecond: 8000000 });
    let chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
      const url = URL.createObjectURL(new Blob(chunks, { type: 'video/webm' }));
      downloadEl.innerHTML = `<a href="${url}" download="reels_1080p.webm" style="color:#38bdf8">Download Video</a>`;
      recording = false; statusEl.textContent = "Status: Done!";
    };
    recorder.start(); requestAnimationFrame(animate);
    setTimeout(() => recorder.stop(), targetDuration * 1000);
  };
</script>
</body>
</html>
