<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Reels Editor - Anti-Stutter Render</title>
<style>
    body { background: #020617; color: #fff; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    .card { background: #0f172a; padding: 20px; border-radius: 20px; border: 1px solid #1e293b; width: 100%; max-width: 400px; text-align: center; margin-bottom: 20px; }
    canvas { background: #808080; border-radius: 12px; max-height: 65vh; max-width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    .btn { background: #2563eb; color: white; border: none; padding: 15px 30px; border-radius: 30px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; transition: 0.2s; }
    .btn:disabled { background: #334155; opacity: 0.7; }
    #status { margin-top: 10px; font-size: 14px; color: #94a3b8; }
    .progress { width: 100%; height: 6px; background: #1e293b; border-radius: 3px; margin-top: 15px; overflow: hidden; display: none; }
    #pBar { height: 100%; width: 0%; background: #2563eb; transition: width 0.1s; }
</style>
</head>
<body>

<div class="card">
    <h3 style="margin-top:0">Stabilizer Render</h3>
    <button id="renderBtn" class="btn">ðŸŽ¬ DOWNLOAD VIDEO MULUS</button>
    <div class="progress" id="pCont"><div id="pBar"></div></div>
    <div id="status">Siap digunakan</div>
</div>

<canvas id="canvas" width="1080" height="1920"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const renderBtn = document.getElementById('renderBtn');
const statusEl = document.getElementById('status');
const pBar = document.getElementById('pBar');
const pCont = document.getElementById('pCont');

// --- FUNGSI GAMBAR (DIPASTIKAN SMOOTH) ---
function draw(t) {
    ctx.fillStyle = '#808080';
    ctx.fillRect(0, 0, 1080, 1920);

    // Animasi Objek (Uji Kelancaran)
    let y = 960 + Math.sin(t * 3) * 300;
    
    // Shadow / Glow
    ctx.shadowBlur = 40;
    ctx.shadowColor = "rgba(37, 99, 235, 0.5)";
    
    ctx.fillStyle = "#2563eb";
    ctx.beginPath();
    ctx.roundRect(140, y - 75, 800, 150, 30);
    ctx.fill();

    // Reset Shadow untuk Teks
    ctx.shadowBlur = 0;
    ctx.fillStyle = "white";
    ctx.font = "bold 60px sans-serif";
    ctx.textAlign = "center";
    ctx.fillText("FIX MOVEMENT: " + t.toFixed(1) + "s", 540, y + 15);
}

// --- LOGIKA RENDER SINKRON ---
renderBtn.onclick = async () => {
    renderBtn.disabled = true;
    pCont.style.display = 'block';
    statusEl.textContent = "Menghubungkan encoder...";

    // Gunakan stream 0 agar kita yang kontrol kapan frame diambil
    const stream = canvas.captureStream(0); 
    const recorder = new MediaRecorder(stream, {
        mimeType: 'video/webm;codecs=vp8', // Codec paling stabil untuk browser
        videoBitsPerSecond: 8000000 
    });

    let chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/webm' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `mulus-${Date.now()}.webm`;
        a.click();
        statusEl.textContent = "Selesai! Cek folder download.";
        renderBtn.disabled = false;
        pCont.style.display = 'none';
    };

    recorder.start();
    const track = stream.getVideoTracks()[0];
    const fps = 30;
    const duration = 5; // Durasi tes
    const totalFrames = duration * fps;

    for (let i = 0; i <= totalFrames; i++) {
        const currentTime = i / fps;
        draw(currentTime);
        
        // KRUSIAL: Ambil frame secara manual setelah gambar selesai
        track.requestFrame();

        // Update Progress
        let progress = (i / totalFrames) * 100;
        pBar.style.width = progress + "%";
        statusEl.textContent = `Processing Frame: ${i}/${totalFrames}`;

        // JEDA: Memberi waktu iPad melakukan kompresi data (Anti-Lag)
        await new Promise(r => setTimeout(r, 40)); 
    }

    statusEl.textContent = "Finalisasi file...";
    setTimeout(() => recorder.stop(), 500);
};

// Preview awal
draw(0);
</script>
</body>
</html>
