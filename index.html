<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Reels</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;}
@font-face{font-family:'DMSerifCustomBold';src:url('./fonts/DMSerifDisplay-Bold.ttf') format('truetype');font-weight:700;font-style:normal;font-display:swap;}
@font-face{font-family:'PlusJakartaCustom';src:url('./fonts/PlusJakartaSans-Bold.woff2') format('woff2');font-weight:700;font-style:normal;font-display:swap;}

body{
margin:0;
padding:12px;
display:flex;
gap:16px;
background:radial-gradient(circle at top,#020617 0%,#020617 40%,#020617 100%);
color:#e5e7eb;
font-family:'PlusJakartaCustom',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
}

.panel{
background:#020617;
padding:16px 14px;
border-radius:14px;
border:1px solid #1f2937;
box-shadow:0 16px 40px rgba(0,0,0,0.65);
}

.left{
width:380px;
max-width:100%;
flex-shrink:0;
}

.right{
flex:1;
display:flex;
justify-content:center;
align-items:center;
min-width:0;
}

h2{
margin:0 0 4px 0;
font-size:18px;
letter-spacing:0.02em;
}

.field{
margin-top:10px;
}

label{
font-size:13px;
display:block;
margin-bottom:4px;
color:#cbd5f5;
}

textarea{
width:100%;
min-height:56px;
background:#020617;
color:#e5e7eb;
border-radius:10px;
border:1px solid #334155;
padding:9px 11px;
font-size:14px;
line-height:1.5;
resize:vertical;
outline:none;
}

#body{
min-height:130px;
}

.btn-row{
margin-top:12px;
display:flex;
gap:8px;
flex-wrap:wrap;
}

button{
padding:8px 16px;
border-radius:999px;
border:none;
cursor:pointer;
font-size:14px;
font-weight:500;
display:inline-flex;
align-items:center;
gap:6px;
}

.btn-primary{
background:#2563eb;
color:#fff;
}

.btn-secondary{
background:#111827;
color:#e5e7eb;
}

.status{
margin-top:8px;
font-size:12px;
color:#9ca3af;
}

canvas{
background:#808080;
border-radius:18px;
border:1px solid #4b5563;
max-height:92vh;
max-width:100%;
}
</style>
</head>

<body>

<div class="panel left">

<h2>Reels Editor</h2>

<div class="field">
<label>Upper</label>
<textarea id="upper"></textarea>
</div>

<div class="field">
<label>Judul</label>
<textarea id="title"></textarea>
</div>

<div class="field">
<label>Subjudul</label>
<textarea id="subtitle"></textarea>
</div>

<div class="field">
<label>Isi</label>
<textarea id="body"></textarea>
</div>

<div class="btn-row">
<button class="btn-secondary" id="previewBtn">üëÅÔ∏è Preview</button>
<button class="btn-primary" id="renderBtn">üé¨ Render MP4</button>
</div>

<div class="status" id="status">
Status: idle
</div>

</div>

<div class="panel right">
<canvas id="canvas" width="1080" height="1920"></canvas>
</div>

<!-- FFmpeg -->
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>

<script>

const { createFFmpeg, fetchFile } = FFmpeg;

const ffmpeg = createFFmpeg({
log:false
});

const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');

const LOGICAL_WIDTH=1080;
const LOGICAL_HEIGHT=1920;
const SCALE=1.5;

canvas.width=LOGICAL_WIDTH*SCALE;
canvas.height=LOGICAL_HEIGHT*SCALE;

ctx.scale(SCALE,SCALE);

const upperEl=document.getElementById('upper');
const titleEl=document.getElementById('title');
const subtitleEl=document.getElementById('subtitle');
const bodyEl=document.getElementById('body');

const previewBtn=document.getElementById('previewBtn');
const renderBtn=document.getElementById('renderBtn');
const statusEl=document.getElementById('status');

let animating=false;
let animStart=null;

let targetDuration=12;
let bodyPages=[];
let pageDurations=[];
let titleCanvas=null;

const TITLE_PRE_HOLD=0.3;
const TITLE_WIPE=0.8;
const TITLE_STATIC=2.0;
const BODY_WIPE=0.4;
const PAGE_GAP=1.0;
const READING_WORDS_PER_SEC=3.0;

function setStatus(t){
statusEl.textContent="Status: "+t;
}

function wrapText(text,maxWidth,fontSpec){

if(fontSpec)ctx.font=fontSpec;

const words=text.split(" ");
let lines=[];
let line=words[0]||"";

for(let i=1;i<words.length;i++){

const test=line+" "+words[i];

if(ctx.measureText(test).width>maxWidth){

lines.push(line);
line=words[i];

}else{

line=test;

}

}

lines.push(line);

return lines;

}

function rebuildTitleLayout(){

const textWidth=830;

const upperLines=wrapText(upperEl.value,textWidth,"700 34px PlusJakartaCustom");
const titleLines=wrapText(titleEl.value,textWidth,"700 90px DMSerifCustomBold");
const subtitleLines=wrapText(subtitleEl.value,textWidth,"700 34px PlusJakartaCustom");

titleCanvas=document.createElement("canvas");

titleCanvas.width=1080;
titleCanvas.height=1920;

const tCtx=titleCanvas.getContext("2d");

tCtx.fillStyle="#ffffff";
tCtx.textAlign="left";

let y=1220;

tCtx.font="700 34px PlusJakartaCustom";

upperLines.forEach(l=>{
tCtx.fillText(l,110,y);
y+=36;
});

y+=70;

tCtx.font="700 90px DMSerifCustomBold";

titleLines.forEach(l=>{
tCtx.fillText(l,110,y);
y+=90;
});

tCtx.font="700 34px PlusJakartaCustom";

subtitleLines.forEach(l=>{
tCtx.fillText(l,110,y);
y+=36;
});

}

function drawFrame(t){

ctx.fillStyle="#808080";
ctx.fillRect(0,0,1080,1920);

if(titleCanvas){

ctx.drawImage(titleCanvas,0,0);

}

}

function recompute(){

rebuildTitleLayout();

const words=bodyEl.value.split(/\s+/).length;

targetDuration=
TITLE_PRE_HOLD+
TITLE_WIPE+
TITLE_STATIC+
Math.max(4,words/READING_WORDS_PER_SEC);

}

function animate(ts){

if(!animating)return;

if(!animStart)animStart=ts;

const elapsed=(ts-animStart)/1000;

drawFrame(elapsed);

if(elapsed<targetDuration){

requestAnimationFrame(animate);

}else{

animating=false;
setStatus("idle");

}

}

previewBtn.onclick=()=>{

recompute();

animStart=null;

animating=true;

requestAnimationFrame(animate);

};

async function convertWebMtoMP4(webmBlob){

setStatus("Loading encoder...");

if(!ffmpeg.loaded){

await ffmpeg.load();

}

setStatus("Converting to MP4...");

ffmpeg.FS("writeFile","input.webm",await fetchFile(webmBlob));

await ffmpeg.run(

"-i","input.webm",
"-c:v","libx264",
"-preset","ultrafast",
"-pix_fmt","yuv420p",
"output.mp4"

);

const data=ffmpeg.FS("readFile","output.mp4");

return new Blob([data.buffer],{type:"video/mp4"});

}

renderBtn.onclick=()=>{

recompute();

const stream=canvas.captureStream(30);

const recorder=new MediaRecorder(stream,{
mimeType:"video/webm;codecs=vp9"
});

let chunks=[];

recorder.ondataavailable=e=>{
chunks.push(e.data);
};

recorder.onstop=async()=>{

const webmBlob=new Blob(chunks,{type:"video/webm"});

const mp4Blob=await convertWebMtoMP4(webmBlob);

const a=document.createElement("a");

a.href=URL.createObjectURL(mp4Blob);

a.download="reels.mp4";

a.click();

setStatus("Done (MP4)");

};

recorder.start();

setStatus("Recording...");

animating=true;

animStart=null;

requestAnimationFrame(animate);

setTimeout(()=>{
recorder.stop();
},targetDuration*1000+500);

};

window.onload=()=>{
recompute();
drawFrame(0);
};

</script>

</body>
</html>
