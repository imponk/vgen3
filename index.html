<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Reels Editor - Strict Frame Fix</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box;}
@font-face{font-family:'DMSerifCustomBold';src:url('./fonts/DMSerifDisplay-Bold.ttf') format('truetype');font-weight:700;font-style:normal;font-display:swap;}
@font-face{font-family:'PlusJakartaCustom';src:url('./fonts/PlusJakartaSans-Bold.woff2') format('woff2');font-weight:700;font-style:normal;font-display:swap;}
body{margin:0;padding:12px;display:flex;gap:16px;background:#020617;color:#e5e7eb;font-family:'PlusJakartaCustom',sans-serif;}
.panel{background:#020617;padding:16px 14px;border-radius:14px;border:1px solid #1f2937;}
.left{width:380px;flex-shrink:0;}
.right{flex:1;display:flex;justify-content:center;align-items:center;}
textarea{width:100%;min-height:56px;background:#0f172a;color:#fff;border-radius:10px;border:1px solid #334155;padding:10px;margin-bottom:10px;font-size:14px;}
.btn-row{display:flex;gap:8px;margin-top:10px;}
button{padding:10px 18px;border-radius:20px;border:none;cursor:pointer;font-weight:600;}
.btn-primary{background:#2563eb;color:#fff;}
.btn-secondary{background:#334155;color:#fff;}
.progress-container{margin-top:10px;height:6px;background:#1e293b;border-radius:3px;overflow:hidden;}
.progress-bar{height:100%;width:0%;background:#2563eb;}
canvas{background:#808080;border-radius:18px;max-height:85vh;max-width:100%;}
</style>
</head>
<body>
<div class="panel left">
    <h2>Reels Editor (Strict Sync)</h2>
    <label>Upper</label><textarea id="upper">QUOTES OF THE DAY</textarea>
    <label>Judul</label><textarea id="title">Rahasia Menjadi Lebih Produktif</textarea>
    <label>Subjudul</label><textarea id="subtitle">Edisi Motivasi Pagi</textarea>
    <label>Isi</label><textarea id="body" style="min-height:130px;">Fokus pada [[satu hal]] setiap waktu.&#10;Jangan biarkan distraksi mengganggu.</textarea>
    <div class="btn-row">
        <button class="btn-secondary" id="previewBtn">Preview</button>
        <button class="btn-primary" id="renderBtn">Render (No Interruption)</button>
    </div>
    <div id="status" style="margin-top:10px;font-size:12px;">Status: idle</div>
    <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
</div>
<div class="panel right"><canvas id="canvas" width="1080" height="1920"></canvas></div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const progressBar = document.querySelector('.progress-bar');
const statusEl = document.getElementById('status');

canvas.width = 1080; canvas.height = 1920;

// Konstanta Timing Persis Style Anda
const TITLE_WIPE = 0.8, TITLE_STATIC = 2.0, BODY_WIPE = 0.5, HIGHLIGHT_DUR = 0.8;

function drawFrame(t) {
    ctx.fillStyle = '#808080';
    ctx.fillRect(0, 0, 1080, 1920);
    const margin = 110;

    // --- 1. ANIMASI JUDUL (Style Wipe) ---
    let pTitle = Math.min(1, t / TITLE_WIPE);
    let smoothTitle = pTitle * pTitle * (3 - 2 * pTitle); // Smoothstep
    
    ctx.save();
    ctx.beginPath();
    ctx.rect(0, 0, margin + (860 * smoothTitle), 1920);
    ctx.clip();
    
    ctx.fillStyle = '#ffffff';
    ctx.textAlign = 'left';
    ctx.font = "700 34px 'PlusJakartaCustom'";
    ctx.fillText(document.getElementById('upper').value, margin, 1220);
    ctx.font = "700 90px 'DMSerifCustomBold'";
    ctx.fillText(document.getElementById('title').value, margin, 1330);
    ctx.font = "700 34px 'PlusJakartaCustom'";
    ctx.fillText(document.getElementById('subtitle').value, margin, 1385);
    ctx.restore();

    // --- 2. ANIMASI ISI (Highlight Style) ---
    const startBody = TITLE_WIPE + TITLE_STATIC;
    if (t > startBody) {
        const bodyT = t - startBody;
        const lines = document.getElementById('body').value.split('\n');
        
        let pBody = Math.min(1, bodyT / BODY_WIPE);
        ctx.save();
        ctx.beginPath();
        ctx.rect(margin, 0, 860 * pBody, 1920);
        ctx.clip();

        lines.forEach((line, i) => {
            let y = 1500 + (i * 75);
            let cleanLine = line.replace(/\[\[/g, '').replace(/\]\]/g, '');
            
            if (line.includes('[[')) {
                let pHigh = Math.max(0, Math.min((bodyT - 0.3 - (i*0.2)) / HIGHLIGHT_DUR, 1));
                ctx.fillStyle = "rgba(0,136,216,0.6)";
                ctx.fillRect(margin - 5, y - 48, 500 * pHigh, 65);
            }
            
            ctx.fillStyle = "#fff";
            ctx.font = "700 54px 'PlusJakartaCustom'";
            ctx.fillText(cleanLine, margin, y);
        });
        ctx.restore();
    }
}

// RENDERER: SINKRONISASI KETAT
document.getElementById('renderBtn').onclick = async () => {
    statusEl.textContent = "Status: Rendering Frame-by-Frame...";
    const fps = 30;
    const duration = 10; 
    const totalFrames = duration * fps;
    
    const stream = canvas.captureStream(0); // Capture Manual
    const recorder = new MediaRecorder(stream, {
        mimeType: 'video/webm;codecs=vp8',
        videoBitsPerSecond: 5000000 
    });

    let chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/webm' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `reels-fixed.webm`;
        a.click();
        statusEl.textContent = "Status: Selesai!";
    };

    recorder.start();
    const track = stream.getVideoTracks()[0];

    for (let i = 0; i <= totalFrames; i++) {
        drawFrame(i / fps); // Animasi dipaksa ikut hitungan frame
        track.requestFrame(); // Ambil frame HANYA setelah gambar selesai
        
        progressBar.style.width = ((i / totalFrames) * 100) + "%";
        // Beri jeda kecil agar hardware iPad bisa memproses encoding tiap frame
        if (i % 2 === 0) await new Promise(r => setTimeout(r, 10));
    }

    setTimeout(() => recorder.stop(), 500);
};

document.getElementById('previewBtn').onclick = () => {
    let start = performance.now();
    function step(now) {
        let elapsed = (now - start) / 1000;
        drawFrame(elapsed);
        if (elapsed < 10) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
};

window.onload = () => drawFrame(0);
</script>
</body>
</html>
