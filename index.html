<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Reels Editor - Final Click-to-Download</title>
<style>
    body { background: #020617; color: #fff; font-family: system-ui; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    canvas { background: #808080; border-radius: 16px; max-height: 70vh; max-width: 100%; border: 1px solid #334155; }
    .panel { background: #0f172a; padding: 20px; border-radius: 16px; border: 1px solid #1e293b; width: 100%; max-width: 400px; margin-bottom: 20px; text-align: center; }
    .btn-main { background: #2563eb; color: white; width: 100%; padding: 15px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; }
    .btn-main:disabled { background: #334155; cursor: not-allowed; }
    #status { margin-top: 12px; font-size: 14px; color: #94a3b8; }
    .progress-container { width: 100%; height: 6px; background: #1e293b; border-radius: 3px; margin-top: 10px; display: none; }
    #progressBar { height: 100%; width: 0%; background: #2563eb; border-radius: 3px; }
</style>
</head>
<body>

<div class="panel">
    <h3 style="margin-top:0">Reels Stable Render</h3>
    <button id="startBtn" class="btn-main">ðŸŽ¬ DOWNLOAD VIDEO MULUS</button>
    <div class="progress-container" id="pCont"><div id="progressBar"></div></div>
    <div id="status">Status: Ready</div>
</div>

<canvas id="canvas" width="1080" height="1920"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startBtn');
const statusEl = document.getElementById('status');
const pBar = document.getElementById('progressBar');
const pCont = document.getElementById('pCont');

// --- LOGIKA GAMBAR ---
function draw(t) {
    ctx.fillStyle = '#808080';
    ctx.fillRect(0, 0, 1080, 1920);

    // Animasi Judul (Wipe)
    let p = Math.min(1, t / 1.5);
    let ease = p * p * (3 - 2 * p);
    
    ctx.save();
    ctx.beginPath();
    ctx.rect(0, 0, 110 + (860 * ease), 1920);
    ctx.clip();
    ctx.fillStyle = "white";
    ctx.font = "bold 90px sans-serif";
    ctx.fillText("HASIL MULUS", 110, 1300);
    ctx.restore();

    // Animasi Highlight
    if (t > 1.8) {
        let hP = Math.min(1, (t - 1.8) / 0.8);
        ctx.fillStyle = "rgba(0,136,216,0.6)";
        ctx.fillRect(110, 1395, 500 * hP, 75);
        ctx.fillStyle = "white";
        ctx.font = "bold 50px sans-serif";
        ctx.fillText("100% Tanpa Patah", 110, 1460);
    }
}

// --- LOGIKA RENDER ---
startBtn.onclick = async () => {
    startBtn.disabled = true;
    pCont.style.display = 'block';
    statusEl.textContent = "Menyiapkan Encoder...";

    const stream = canvas.captureStream(0); // Manual stream
    const recorder = new MediaRecorder(stream, {
        mimeType: 'video/webm;codecs=vp8',
        videoBitsPerSecond: 8000000
    });

    let chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/webm' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `reels-mulus.webm`;
        a.click();
        statusEl.textContent = "Selesai! Cek Download.";
        startBtn.disabled = false;
        pCont.style.display = 'none';
    };

    recorder.start();
    const track = stream.getVideoTracks()[0];
    const fps = 30;
    const duration = 5; // 5 detik video
    const totalFrames = duration * fps;

    // LOOP RENDER ASYNC (Ini yang bikin tidak diam saja)
    for (let i = 0; i <= totalFrames; i++) {
        draw(i / fps);
        
        // Memaksa recorder menangkap frame ini
        if (track.requestFrame) {
            track.requestFrame();
        }

        // Update UI
        let progress = (i / totalFrames) * 100;
        pBar.style.width = progress + "%";
        statusEl.textContent = `Rendering: ${Math.round(progress)}%`;

        // Memberi napas pada CPU iPad agar tidak macet
        await new Promise(r => setTimeout(r, 40)); 
    }

    statusEl.textContent = "Mengemas Video...";
    setTimeout(() => recorder.stop(), 500);
};

// Gambar tampilan awal
draw(0);
</script>
</body>
</html>
