<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Reels Editor - Final iPad Stable</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box;}
@font-face{font-family:'DMSerifCustomBold';src:url('./fonts/DMSerifDisplay-Bold.ttf') format('truetype');font-weight:700;font-style:normal;font-display:swap;}
@font-face{font-family:'PlusJakartaCustom';src:url('./fonts/PlusJakartaSans-Bold.woff2') format('woff2');font-weight:700;font-style:normal;font-display:swap;}
body{margin:0;padding:12px;display:flex;gap:16px;background:#020617;color:#e5e7eb;font-family:'PlusJakartaCustom',sans-serif;}
.panel{background:#020617;padding:16px 14px;border-radius:14px;border:1px solid #1f2937;}
.left{width:380px;flex-shrink:0;}
.right{flex:1;display:flex;justify-content:center;align-items:center;}
h2{margin:0 0 4px 0;font-size:18px;}
textarea{width:100%;min-height:56px;background:#0f172a;color:#fff;border-radius:10px;border:1px solid #334155;padding:10px;margin-bottom:10px;font-size:14px;}
.btn-row{display:flex;gap:8px;margin-top:10px;}
button{padding:10px 18px;border-radius:20px;border:none;cursor:pointer;font-weight:600;}
.btn-primary{background:#2563eb;color:#fff;}
.btn-secondary{background:#334155;color:#fff;}
.progress-container{margin-top:10px;height:6px;background:#1e293b;border-radius:3px;overflow:hidden;}
.progress-bar{height:100%;width:0%;background:#2563eb;}
canvas{background:#808080;border-radius:18px;max-height:85vh;max-width:100%;}
</style>
</head>
<body>
<div class="panel left">
    <h2>Reels Editor</h2>
    <label>Upper</label><textarea id="upper">QUOTES OF THE DAY</textarea>
    <label>Judul</label><textarea id="title">Rahasia Menjadi Lebih Produktif</textarea>
    <label>Isi</label><textarea id="body" style="min-height:130px;">Fokus pada [[satu hal]] setiap waktu.&#10;Jangan biarkan distraksi mengganggu.</textarea>
    <div class="btn-row">
        <button class="btn-secondary" id="previewBtn">Preview</button>
        <button class="btn-primary" id="renderBtn">Render (Stable Mode)</button>
    </div>
    <div id="status" style="margin-top:10px;font-size:12px;">Status: idle</div>
    <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
</div>
<div class="panel right"><canvas id="canvas" width="1080" height="1920"></canvas></div>

<script>
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const progressBar=document.querySelector('.progress-bar');
const statusEl=document.getElementById('status');

// Gunakan resolusi standar agar tidak membebani memori iPad
canvas.width=1080; 
canvas.height=1920;

let targetDuration=10;
let titleCanvas=null;

// --- FUNGSI ANIMASI SESUAI KEINGINAN ANDA ---
function drawFrame(t) {
    ctx.fillStyle = '#808080';
    ctx.fillRect(0, 0, 1080, 1920);

    // Header & Judul Statis (Pre-drawn for speed)
    if(!titleCanvas) {
        titleCanvas = document.createElement('canvas');
        titleCanvas.width = 1080; titleCanvas.height = 1920;
        const tCtx = titleCanvas.getContext('2d');
        tCtx.fillStyle = '#ffffff';
        tCtx.textAlign = 'left';
        tCtx.font = "700 34px 'PlusJakartaCustom'";
        tCtx.fillText(document.getElementById('upper').value, 110, 1220);
        tCtx.font = "700 85px 'DMSerifCustomBold'";
        tCtx.fillText(document.getElementById('title').value, 110, 1330);
    }

    // Wipe Effect
    let wipe = Math.min(1, t / 1.2);
    ctx.save();
    ctx.beginPath();
    ctx.rect(0, 0, 110 + (860 * wipe), 1920);
    ctx.clip();
    ctx.drawImage(titleCanvas, 0, 0);
    
    // Body Text & Highlight Logic (Sederhana agar lancar)
    ctx.fillStyle = "#fff";
    ctx.font = "700 50px 'PlusJakartaCustom'";
    const lines = document.getElementById('body').value.split('\n');
    lines.forEach((line, i) => {
        let cleanLine = line.replace('[[','').replace(']]','');
        ctx.fillText(cleanLine, 110, 1450 + (i * 70));
        if(line.includes('[[')) {
            let pHigh = Math.max(0, Math.min((t - 1.5 - (i*0.5)), 1));
            ctx.fillStyle = "rgba(0,136,216,0.6)";
            ctx.fillRect(110, 1405 + (i * 70), 400 * pHigh, 60);
            ctx.fillStyle = "#fff";
        }
    });
    ctx.restore();
}

// --- RENDERER YANG TIDAK AKAN MACET ---
document.getElementById('renderBtn').onclick = async () => {
    titleCanvas = null; // reset cache
    statusEl.textContent = "Status: Recording...";
    
    // Gunakan MediaRecorder tapi dengan Frame Capture Manual
    const stream = canvas.captureStream(0); 
    const recorder = new MediaRecorder(stream, {
        mimeType: 'video/webm;codecs=vp8',
        videoBitsPerSecond: 3000000 
    });

    let chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/webm' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `reels-${Date.now()}.webm`;
        a.click();
        statusEl.textContent = "Selesai! Coba masukkan ke CapCut.";
    };

    recorder.start();
    const track = stream.getVideoTracks()[0];
    const fps = 30;
    const totalFrames = targetDuration * fps;

    for (let i = 0; i <= totalFrames; i++) {
        drawFrame(i / fps);
        track.requestFrame(); // Ambil frame saat ini
        
        let progress = i / totalFrames;
        progressBar.style.width = (progress * 100) + "%";
        
        // JEDA KRUSIAL: Memberi waktu iPad menulis ke file tanpa membebani RAM
        if (i % 5 === 0) await new Promise(r => setTimeout(r, 20));
    }

    // Jeda akhir agar file tertutup sempurna
    setTimeout(() => recorder.stop(), 1000);
};

// Preview
document.getElementById('previewBtn').onclick = () => {
    let start = performance.now();
    function step(now) {
        let elapsed = (now - start) / 1000;
        drawFrame(elapsed);
        if (elapsed < targetDuration) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
};
</script>
</body>
</html>
