<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Reels Renderer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>

@font-face{
font-family:'DMSerifCustomBold';
src:url('./fonts/DMSerifDisplay-Bold.ttf') format('truetype');
font-weight:700;
font-display:swap;
}

@font-face{
font-family:'PlusJakartaCustom';
src:url('./fonts/PlusJakartaSans-Bold.woff2') format('woff2');
font-weight:700;
font-display:swap;
}

body{
margin:0;
padding:12px;
display:flex;
gap:16px;
background:#020617;
color:#e5e7eb;
font-family:'PlusJakartaCustom',system-ui;
}

.panel{
width:380px;
background:#020617;
padding:14px;
border-radius:12px;
border:1px solid #1f2937;
}

canvas{
background:#808080;
border-radius:16px;
border:1px solid #374151;
}

textarea{
width:100%;
background:#020617;
color:#e5e7eb;
border:1px solid #334155;
border-radius:8px;
padding:8px;
margin-bottom:8px;
resize:vertical;
}

button{
padding:8px 14px;
border-radius:999px;
border:none;
cursor:pointer;
margin-right:6px;
}

.preview{
background:#111827;
color:white;
}

.render{
background:#2563eb;
color:white;
}

.status{
font-size:12px;
color:#9ca3af;
margin-top:6px;
}

.progress{
width:100%;
height:6px;
background:#1f2937;
border-radius:999px;
overflow:hidden;
margin-top:6px;
}

.progress-bar{
height:100%;
width:0%;
background:#2563eb;
}

</style>
</head>
<body>

<div class="panel">

Upper
<textarea id="upper"></textarea>

Judul
<textarea id="title"></textarea>

Subjudul
<textarea id="subtitle"></textarea>

Isi (gunakan [[highlight]])
<textarea id="body"></textarea>

<button class="preview" id="previewBtn">Preview</button>
<button class="render" id="renderBtn">Render WEBM VP8</button>

<div class="status" id="status">idle</div>
<div class="progress"><div class="progress-bar" id="progressBar"></div></div>

</div>

<canvas id="canvas" width="1080" height="1920"></canvas>

<script>

const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

const statusEl=document.getElementById("status");
const progressBar=document.getElementById("progressBar");

function setStatus(s){statusEl.textContent=s;}
function setProgress(p){progressBar.style.width=p+"%";}

const upperEl=document.getElementById("upper");
const titleEl=document.getElementById("title");
const subtitleEl=document.getElementById("subtitle");
const bodyEl=document.getElementById("body");

const previewBtn=document.getElementById("previewBtn");
const renderBtn=document.getElementById("renderBtn");

/* ENGINE PARAMETER — sama seperti milik kamu */

const TITLE_PRE_HOLD=0.3;
const TITLE_WIPE=0.8;
const TITLE_STATIC=2;

const PAGE_GAP=1;
const READING_WORDS_PER_SEC=3;
const HIGHLIGHT_LINE_DUR=0.8;

let titleCanvas;
let bodyPages=[];
let pageDurations=[];
let targetDuration=0;

let animating=false;
let animStart=null;

/* TOKENIZER — RULE [[highlight]] */

function tokenizeHighlighted(text){

let tokens=[];
let buf='';
let hi=false;
let i=0;

function flush(){
if(buf.length>0){
tokens.push({text:buf,highlight:hi});
buf='';
}
}

while(i<text.length){

if(!hi&&text.startsWith('[[',i)){
flush();
hi=true;
i+=2;
}

else if(hi&&text.startsWith(']]',i)){
flush();
hi=false;
i+=2;
}

else{
let ch=text[i];
buf+=ch;
if(ch===' ')flush();
i++;
}

}

flush();

return tokens;

}

/* WRAP RICH PARAGRAPH — ASLI ENGINE KAMU */

function wrapRichParagraph(text,maxWidth,font){

ctx.font=font;

const tokens=tokenizeHighlighted(text);

let lines=[];
let line=[];
let width=0;

tokens.forEach(token=>{

const w=ctx.measureText(token.text).width;

if(width+w>maxWidth&&line.length>0){

lines.push(line);
line=[];
width=0;

}

line.push(token);
width+=w;

});

if(line.length>0)lines.push(line);

return lines;

}

/* BUILD TITLE */

function rebuildTitle(){

titleCanvas=document.createElement("canvas");
titleCanvas.width=1080;
titleCanvas.height=1920;

const t=titleCanvas.getContext("2d");

t.fillStyle="white";

let y=1220;

t.font="700 34px PlusJakartaCustom";

upperEl.value.split("\n").forEach(l=>{
t.fillText(l,110,y);
y+=36;
});

y+=80;

t.font="700 90px DMSerifCustomBold";

titleEl.value.split("\n").forEach(l=>{
t.fillText(l,110,y);
y+=90;
});

y-=20;

t.font="700 34px PlusJakartaCustom";

subtitleEl.value.split("\n").forEach(l=>{
t.fillText(l,110,y);
y+=36;
});

}

/* DRAW TITLE SCENE — WIPE SESUAI ENGINE KAMU */

function drawTitleScene(t){

ctx.fillStyle="#808080";
ctx.fillRect(0,0,1080,1920);

if(t<TITLE_PRE_HOLD){

ctx.drawImage(titleCanvas,0,0);
return;

}

const wipeT=(t-TITLE_PRE_HOLD)/TITLE_WIPE;

const w=Math.min(1080,wipeT*1080);

ctx.save();
ctx.beginPath();
ctx.rect(0,0,w,1920);
ctx.clip();

ctx.drawImage(titleCanvas,0,0);

ctx.restore();

}

/* DRAW BODY PAGE — HIGHLIGHT BERJALAN */

function drawBodyPage(pageIndex,time){

ctx.fillStyle="#808080";
ctx.fillRect(0,0,1080,1920);

ctx.font="700 54px PlusJakartaCustom";

let y=1220;

const lines=bodyPages[pageIndex]||[];

lines.forEach((line,id)=>{

let x=110;

const startT=id*HIGHLIGHT_LINE_DUR;
const progress=Math.min(1,Math.max(0,(time-startT)/HIGHLIGHT_LINE_DUR));

line.forEach(token=>{

if(token.highlight){

ctx.fillStyle="#2563eb";

const w=ctx.measureText(token.text).width;

ctx.fillRect(x,y-46,w*progress,54);

ctx.fillStyle="white";

}

ctx.fillText(token.text,x,y);

x+=ctx.measureText(token.text).width;

});

y+=64;

});

}

/* FRAME CONTROLLER */

function drawFrame(globalT){

const titleTotal=TITLE_PRE_HOLD+TITLE_WIPE+TITLE_STATIC;

if(globalT<titleTotal){

drawTitleScene(globalT);
return;

}

let t=globalT-titleTotal-PAGE_GAP;

let acc=0;

for(let i=0;i<bodyPages.length;i++){

const dur=pageDurations[i];

if(t<acc+dur){

drawBodyPage(i,t-acc);
return;

}

acc+=dur+PAGE_GAP;

}

}

/* COMPUTE */

function recompute(){

rebuildTitle();

bodyPages=bodyEl.value
.split("\n\n")
.filter(p=>p.trim())
.map(p=>wrapRichParagraph(p,860,"700 54px PlusJakartaCustom"));

pageDurations=bodyPages.map(p=>
Math.max(4,p.length*HIGHLIGHT_LINE_DUR)
);

targetDuration=
TITLE_PRE_HOLD+
TITLE_WIPE+
TITLE_STATIC+
pageDurations.reduce((a,b)=>a+b,0)+
PAGE_GAP*(bodyPages.length+1);

}

/* ANIMATE — FIX FREEZE */

function animate(ts){

if(!animating)return;

if(animStart===null){
animStart=ts;
}

const elapsed=(ts-animStart)/1000;

drawFrame(elapsed);

setProgress(Math.min(100,(elapsed/targetDuration)*100));

if(elapsed<targetDuration){

requestAnimationFrame(animate);

}else{

animating=false;
setStatus("idle");

}

}

/* PREVIEW */

previewBtn.onclick=()=>{

recompute();

setStatus("preview");

animStart=null;
animating=true;

requestAnimationFrame(animate);

};

/* RENDER VP8 */

renderBtn.onclick=()=>{

recompute();

setStatus("recording");

const stream=canvas.captureStream(30);

const recorder=new MediaRecorder(stream,{
mimeType:'video/webm;codecs=vp8',
videoBitsPerSecond:8000000
});

let chunks=[];

recorder.ondataavailable=e=>{
if(e.data.size>0)chunks.push(e.data);
};

recorder.onstop=()=>{

setStatus("saving");

const blob=new Blob(chunks,{type:'video/webm'});

const a=document.createElement("a");

a.href=URL.createObjectURL(blob);
a.download="reels.webm";
a.click();

setStatus("done");

};

recorder.start();

animStart=null;
animating=true;

requestAnimationFrame(animate);

setTimeout(()=>recorder.stop(),targetDuration*1000+500);

};

recompute();
drawFrame(0);

</script>

</body>
</html>
