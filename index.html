<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Reels</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box;}
@font-face{font-family:'DMSerifCustomBold';src:url('./fonts/DMSerifDisplay-Bold.ttf') format('truetype');font-weight:700;font-style:normal;font-display:swap;}
@font-face{font-family:'PlusJakartaCustom';src:url('./fonts/PlusJakartaSans-Bold.woff2') format('woff2');font-weight:700;font-style:normal;font-display:swap;}

body{
margin:0;
padding:12px;
display:flex;
gap:16px;
background:radial-gradient(circle at top,#020617 0%,#020617 40%,#020617 100%);
color:#e5e7eb;
font-family:'PlusJakartaCustom',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
}

.panel{
background:#020617;
padding:16px 14px;
border-radius:14px;
border:1px solid #1f2937;
box-shadow:0 16px 40px rgba(0,0,0,0.65);
}

.left{
width:380px;
max-width:100%;
flex-shrink:0;
}

.right{
flex:1;
display:flex;
justify-content:center;
align-items:center;
min-width:0;
}

h2{
margin:0 0 4px 0;
font-size:18px;
letter-spacing:0.02em;
}

.field{margin-top:10px;}

label{
font-size:13px;
display:block;
margin-bottom:4px;
color:#cbd5f5;
}

textarea{
width:100%;
min-height:56px;
background:#020617;
color:#e5e7eb;
border-radius:10px;
border:1px solid #334155;
padding:9px 11px;
font-size:14px;
line-height:1.5;
resize:vertical;
outline:none;
}

#body{min-height:130px;}

.btn-row{
margin-top:12px;
display:flex;
gap:8px;
flex-wrap:wrap;
}

button{
padding:8px 16px;
border-radius:999px;
border:none;
cursor:pointer;
font-size:14px;
font-weight:500;
display:inline-flex;
align-items:center;
gap:6px;
}

.btn-primary{background:#2563eb;color:#fff;}
.btn-secondary{background:#111827;color:#e5e7eb;}

.status{
margin-top:8px;
font-size:12px;
color:#9ca3af;
}

/* PROGRESS BAR TAMBAHAN */
.progress{
margin-top:6px;
width:100%;
height:6px;
background:#111827;
border-radius:999px;
overflow:hidden;
}

.progress-bar{
width:0%;
height:100%;
background:#2563eb;
transition:width 0.1s linear;
}

canvas{
background:#808080;
border-radius:18px;
border:1px solid #4b5563;
max-height:92vh;
max-width:100%;
}

</style>
</head>
<body>

<div class="panel left">

<h2>Reels Editor</h2>

<div class="field">
<label>Upper</label>
<textarea id="upper"></textarea>
</div>

<div class="field">
<label>Judul</label>
<textarea id="title"></textarea>
</div>

<div class="field">
<label>Subjudul</label>
<textarea id="subtitle"></textarea>
</div>

<div class="field">
<label>Isi</label>
<textarea id="body"></textarea>
</div>

<div class="btn-row">
<button class="btn-secondary" id="previewBtn">üëÅÔ∏è Preview</button>
<button class="btn-primary" id="renderBtn">üé¨ Render (WEBM VP8)</button>
</div>

<div class="status" id="status">Status: idle</div>

<div class="progress">
<div class="progress-bar" id="progressBar"></div>
</div>

</div>

<div class="panel right">
<canvas id="canvas" width="1080" height="1920"></canvas>
</div>

<script>

/* SEMUA ENGINE ASLI ‚Äî TIDAK DIUBAH */

const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');

const progressBar=document.getElementById('progressBar');

const LOGICAL_WIDTH=1080;
const LOGICAL_HEIGHT=1920;
const SCALE=1.5;

canvas.width=LOGICAL_WIDTH*SCALE;
canvas.height=LOGICAL_HEIGHT*SCALE;
ctx.scale(SCALE,SCALE);

const upperEl=document.getElementById('upper');
const titleEl=document.getElementById('title');
const subtitleEl=document.getElementById('subtitle');
const bodyEl=document.getElementById('body');
const previewBtn=document.getElementById('previewBtn');
const renderBtn=document.getElementById('renderBtn');
const statusEl=document.getElementById('status');

let animating=false,recording=false,animStart=null;
let targetDuration=12,bodyPages=[],pageDurations=[];
let titleCanvas=null;
let titleLayout={marginLeft:110,textWidth:830,upperLines:[],titleLines:[],subtitleLines:[]};

const TITLE_PRE_HOLD=0.3;
const TITLE_WIPE=0.8;
const TITLE_STATIC=2.0;
const BODY_WIPE=0.4;
const PAGE_GAP=1.0;
const READING_WORDS_PER_SEC=3.0;
const HIGHLIGHT_LINE_DUR=0.8;

function setStatus(t){statusEl.textContent='Status: '+t;}

function wrapText(text,maxWidth,fontSpec){
if(fontSpec)ctx.font=fontSpec;
const paragraphs=text.split(/\r?\n/);
const lines=[];
for(const para of paragraphs){
const trimmed=para.trim();
if(!trimmed){lines.push('');continue;}
const words=trimmed.split(/\s+/);
let line=words[0];
for(let i=1;i<words.length;i++){
if(ctx.measureText(line+' '+words[i]).width>maxWidth){lines.push(line);line=words[i];}
else{line+=' '+words[i];}
}
lines.push(line);
}
return lines;
}

/* SEMUA FUNCTION LAIN IDENTIK ‚Äî DIPERSINGKAT DI SINI DEMI FOKUS PERUBAHAN */

/* ====================================================== */
/* TAMBAHAN PROGRESS UPDATE */
/* ====================================================== */

function updateProgress(elapsed){

const p=Math.min(elapsed/targetDuration,1);
progressBar.style.width=(p*100)+"%";

}

/* ====================================================== */

function animate(ts){

if(!animating)return;

if(!animStart)animStart=ts;

const elapsed=(ts-animStart)/1000;

drawFrame(Math.min(elapsed,targetDuration));

updateProgress(elapsed);

if(elapsed<targetDuration)
requestAnimationFrame(animate);
else{
animating=false;
setStatus("idle");
}

}

/* ====================================================== */
/* VP8 ONLY CHANGE */
/* ====================================================== */

renderBtn.onclick=()=>{

recompute();

const stream=canvas.captureStream(30);

/* VP8 */
const recorder=new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp8'});

let chunks=[];

recorder.ondataavailable=e=>chunks.push(e.data);

recorder.onstop=()=>{

const blob=new Blob(chunks,{type:'video/webm'});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="reels.webm";
a.click();

};

recorder.start();

animating=true;
animStart=null;

requestAnimationFrame(animate);

setTimeout(()=>recorder.stop(),targetDuration*1000+500);

};

</script>
</body>
</html>
