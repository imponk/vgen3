<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Reels Editor - Final Strict Frame Sync</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box;}
@font-face{font-family:'DMSerifCustomBold';src:url('./fonts/DMSerifDisplay-Bold.ttf') format('truetype');font-weight:700;font-style:normal;font-display:swap;}
@font-face{font-family:'PlusJakartaCustom';src:url('./fonts/PlusJakartaSans-Bold.woff2') format('woff2');font-weight:700;font-style:normal;font-display:swap;}
body{margin:0;padding:12px;display:flex;gap:16px;background:radial-gradient(circle at top,#020617 0%,#020617 40%,#020617 100%);color:#e5e7eb;font-family:'PlusJakartaCustom',sans-serif;}
.panel{background:#020617;padding:16px 14px;border-radius:14px;border:1px solid #1f2937;box-shadow:0 16px 40px rgba(0,0,0,0.65);}
.left{width:380px;flex-shrink:0;}
.right{flex:1;display:flex;justify-content:center;align-items:center;}
h2{margin:0 0 4px 0;font-size:18px;}
.field{margin-top:10px;}
label{font-size:13px;display:block;margin-bottom:4px;color:#cbd5f5;}
textarea{width:100%;min-height:56px;background:#020617;color:#e5e7eb;border-radius:10px;border:1px solid #334155;padding:9px 11px;font-size:14px;line-height:1.5;resize:vertical;outline:none;}
.btn-row{margin-top:12px;display:flex;gap:8px;}
button{padding:8px 16px;border-radius:999px;border:none;cursor:pointer;font-size:14px;font-weight:500;}
.btn-primary{background:#2563eb;color:#fff;}
.btn-secondary{background:#111827;color:#e5e7eb;border:1px solid #334155;}
.status{margin-top:8px;font-size:12px;color:#9ca3af;}
.progress-container{margin-top:6px;height:6px;background:#1f2937;border-radius:999px;overflow:hidden;}
.progress-bar{height:100%;width:0%;background:#2563eb;transition:width 0.1s linear;}
canvas{background:#808080;border-radius:18px;border:1px solid #4b5563;max-height:92vh;max-width:100%;}
</style>
</head>
<body>
<div class="panel left">
    <h2>Reels Editor</h2>
    <div class="field"><label>Upper</label><textarea id="upper">QUOTES OF THE DAY</textarea></div>
    <div class="field"><label>Judul</label><textarea id="title">Rahasia Menjadi Lebih Produktif</textarea></div>
    <div class="field"><label>Subjudul</label><textarea id="subtitle">Edisi Motivasi Pagi</textarea></div>
    <div class="field"><label>Isi</label><textarea id="body">Fokus pada [[satu hal]] setiap waktu.&#10;Konsistensi adalah [[kunci utama]].</textarea></div>
    <div class="btn-row">
        <button class="btn-secondary" id="previewBtn">üëÅÔ∏è Preview</button>
        <button class="btn-primary" id="renderBtn">üé¨ Render (Strict Fix)</button>
    </div>
    <div class="status" id="status">Status: idle</div>
    <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
</div>
<div class="panel right"><canvas id="canvas" width="1080" height="1920"></canvas></div>

<script>
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const progressBar=document.querySelector('.progress-bar');
const statusEl=document.getElementById('status');

canvas.width=1080; canvas.height=1920;

// Konstanta Timing (Persis seperti style Anda)
const TITLE_PRE_HOLD=0.3, TITLE_WIPE=0.8, TITLE_STATIC=2.0;
const BODY_WIPE=0.4, PAGE_GAP=1.0, HIGHLIGHT_LINE_DUR=0.8;

function drawFrame(t) {
    ctx.fillStyle = '#808080';
    ctx.fillRect(0, 0, 1080, 1920);

    const margin = 110;
    const textWidth = 830;
    const titleTotal = TITLE_PRE_HOLD + TITLE_WIPE + TITLE_STATIC;

    // --- ANIMASI JUDUL (Style Wipe) ---
    let titleClip = 0;
    if (t > TITLE_PRE_HOLD) {
        let p = Math.min(1, (t - TITLE_PRE_HOLD) / TITLE_WIPE);
        titleClip = p * p * (3 - 2 * p); // Smoothstep
    }
    
    ctx.save();
    ctx.beginPath();
    ctx.rect(0, 0, margin + (textWidth * titleClip), 1920);
    ctx.clip();
    
    ctx.fillStyle = '#ffffff';
    ctx.textAlign = 'left';
    ctx.font = "700 34px 'PlusJakartaCustom'";
    ctx.fillText(document.getElementById('upper').value, margin, 1220);
    ctx.font = "700 90px 'DMSerifCustomBold'";
    ctx.fillText(document.getElementById('title').value, margin, 1330);
    ctx.font = "700 34px 'PlusJakartaCustom'";
    ctx.fillText(document.getElementById('subtitle').value, margin, 1385);
    ctx.restore();

    // --- ANIMASI ISI (Highlight Style) ---
    if (t > titleTotal + PAGE_GAP) {
        const bodyT = t - (titleTotal + PAGE_GAP);
        const lines = document.getElementById('body').value.split('\n');
        
        let bodyWipe = Math.min(1, bodyT / BODY_WIPE);
        ctx.save();
        ctx.beginPath();
        ctx.rect(margin, 0, textWidth * (bodyWipe * bodyWipe * (3 - 2 * bodyWipe)), 1920);
        ctx.clip();

        lines.forEach((line, i) => {
            let y = 1500 + (i * 75);
            let cleanLine = line.replace(/\[\[/g, '').replace(/\]\]/g, '');
            
            if (line.includes('[[')) {
                let startH = i * 0.4;
                let hProgress = Math.max(0, Math.min((bodyT - startH) / HIGHLIGHT_LINE_DUR, 1));
                ctx.fillStyle = "rgba(0,136,216,0.6)";
                ctx.fillRect(margin - 5, y - 48, textWidth * 0.7 * hProgress, 65);
            }
            
            ctx.fillStyle = "#fff";
            ctx.font = "700 54px 'PlusJakartaCustom'";
            ctx.fillText(cleanLine, margin, y);
        });
        ctx.restore();
    }
}

// RENDERER: Kunci pada Frame Index (Bukan Waktu Asli)
document.getElementById('renderBtn').onclick = async () => {
    statusEl.textContent = "Status: Rendering Frame-by-Frame...";
    const fps = 30;
    const duration = 10; // Total durasi video
    const totalFrames = duration * fps;
    
    // Capture manual stream (0 FPS artinya kita yang trigger capture tiap frame)
    const stream = canvas.captureStream(0);
    const recorder = new MediaRecorder(stream, {
        mimeType: 'video/webm;codecs=vp8',
        videoBitsPerSecond: 5000000 
    });

    let chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/webm' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `reels-fixed-${Date.now()}.webm`;
        a.click();
        statusEl.textContent = "Status: idle";
    };

    recorder.start();
    const track = stream.getVideoTracks()[0];

    for (let i = 0; i <= totalFrames; i++) {
        // Kunci matematika animasi: T adalah frame ke-i dibagi FPS
        const t = i / fps;
        drawFrame(t);
        
        // Paksa rekorder mengambil frame ini TEPAT setelah digambar
        track.requestFrame();
        
        progressBar.style.width = ((i / totalFrames) * 100) + "%";
        
        // Beri jeda 30ms agar iPad tidak "tersedak" saat encoding
        await new Promise(r => setTimeout(r, 30));
    }

    // Jeda kecil sebelum tutup rekaman
    setTimeout(() => recorder.stop(), 500);
};

document.getElementById('previewBtn').onclick = () => {
    let start = performance.now();
    function step(now) {
        let elapsed = (now - start) / 1000;
        drawFrame(elapsed);
        if (elapsed < 10) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
};

window.onload = () => drawFrame(0);
</script>
</body>
</html>
