<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Reels Pro 1080p - Fixed Layout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }
    @font-face {
      font-family: 'DMSerifCustomBold';
      src: url('./fonts/DMSerifDisplay-Bold.ttf') format('truetype');
      font-weight: 700; font-style: normal; font-display: swap;
    }
    @font-face {
      font-family: 'PlusJakartaCustom';
      src: url('./fonts/PlusJakartaSans-Bold.woff2') format('woff2');
      font-weight: 700; font-style: normal; font-display: swap;
    }
    body {
      margin: 0; padding: 12px; display: flex; gap: 16px;
      background: #020617; color: #e5e7eb;
      font-family: 'PlusJakartaCustom', sans-serif;
    }
    .panel { background: #020617; padding: 16px; border-radius: 14px; border: 1px solid #1f2937; }
    .left { width: 380px; flex-shrink: 0; }
    .right { flex: 1; display: flex; justify-content: center; align-items: center; }
    textarea {
      width: 100%; min-height: 50px; background: #0f172a; color: #fff;
      border: 1px solid #334155; border-radius: 8px; padding: 10px; margin-bottom: 10px;
    }
    canvas {
      background: #808080; border-radius: 8px; border: 1px solid #4b5563;
      max-height: 90vh; max-width: 100%;
    }
    .btn-primary { background: #2563eb; color: white; padding: 10px 20px; border-radius: 20px; cursor: pointer; border: none; font-weight: bold; }
    .btn-secondary { background: #334155; color: white; padding: 10px 20px; border-radius: 20px; cursor: pointer; border: none; }
    .status { margin-top: 10px; font-size: 12px; color: #9ca3af; }
  </style>
</head>
<body>
  <div class="panel left">
    <h2>Reels 1080p (Fixed)</h2>
    <label>Upper</label>
    <textarea id="upper" placeholder="BREAKING NEWS"></textarea>
    <label>Judul</label>
    <textarea id="title" placeholder="Masukan Judul"></textarea>
    <label>Subjudul</label>
    <textarea id="subtitle" placeholder="Masukan Subjudul"></textarea>
    <label>Isi (Pisah baris kosong untuk ganti slide)</label>
    <textarea id="body" style="height: 150px;"></textarea>
    
    <div style="display:flex; gap:8px;">
      <button class="btn-secondary" id="previewBtn">üëÅÔ∏è Preview</button>
      <button class="btn-primary" id="renderBtn">üé¨ Render 1080p</button>
    </div>
    <div class="status" id="status">Status: idle</div>
    <div id="download" style="margin-top:10px;"></div>
  </div>
  <div class="panel right">
    <canvas id="canvas"></canvas>
  </div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const LOGICAL_WIDTH = 1080;
const LOGICAL_HEIGHT = 1920;

canvas.width = LOGICAL_WIDTH;
canvas.height = LOGICAL_HEIGHT;

const upperEl = document.getElementById('upper');
const titleEl = document.getElementById('title');
const subtitleEl = document.getElementById('subtitle');
const bodyEl = document.getElementById('body');
const statusEl = document.getElementById('status');

let animating = false, recording = false, animStart = null;
let titleCanvas = null, titleTextureReady = false;
let bodyPages = [], pageDurations = [], targetDuration = 10;

/* --- KONFIGURASI MARGIN AGAR TIDAK NABRAK --- */
const MARGIN_LEFT = 110;
const MARGIN_RIGHT = 110;
const TEXT_WIDTH = LOGICAL_WIDTH - MARGIN_LEFT - MARGIN_RIGHT;

/* --- FUNGSI WRAP TEXT --- */
function wrapText(text, maxWidth, fontSpec) {
  ctx.font = fontSpec;
  const words = text.split(' ');
  let lines = [], currentLine = words[0];
  for (let i = 1; i < words.length; i++) {
    if (ctx.measureText(currentLine + " " + words[i]).width < maxWidth) {
      currentLine += " " + words[i];
    } else { lines.push(currentLine); currentLine = words[i]; }
  }
  lines.push(currentLine);
  return lines;
}

/* --- REBUILD JUDUL & SUBJUDUL --- */
function rebuildTitleTexture() {
  titleCanvas = document.createElement('canvas');
  titleCanvas.width = 1080; titleCanvas.height = 1920;
  const tCtx = titleCanvas.getContext('2d');
  tCtx.fillStyle = 'white';
  tCtx.textAlign = 'left';
  
  let y = 1220; 

  if (upperEl.value) {
    tCtx.font = "700 34px 'PlusJakartaCustom'";
    wrapText(upperEl.value, TEXT_WIDTH).forEach(l => { tCtx.fillText(l, MARGIN_LEFT, y); y += 45; });
    y += 40;
  }
  if (titleEl.value) {
    tCtx.font = "700 90px 'DMSerifCustomBold'";
    wrapText(titleEl.value, TEXT_WIDTH).forEach(l => { tCtx.fillText(l, MARGIN_LEFT, y); y += 95; });
    y += 20; 
  }
  if (subtitleEl.value) {
    tCtx.font = "700 34px 'PlusJakartaCustom'";
    wrapText(subtitleEl.value, TEXT_WIDTH).forEach(l => { tCtx.fillText(l, MARGIN_LEFT, y); y += 45; });
  }
  titleTextureReady = true;
}

/* --- DRAWING FRAME --- */
function drawFrame(t) {
  ctx.fillStyle = '#808080';
  ctx.fillRect(0, 0, 1080, 1920);

  const titleTotal = 3.1; // Total durasi scene judul
  if (t < titleTotal) {
    if (!titleTextureReady) rebuildTitleTexture();
    ctx.drawImage(titleCanvas, 0, 0);
    
    // Animasi Wipe (Kiri ke Kanan)
    if (t > 0.3 && t < 1.1) {
      let p = (t - 0.3) / 0.8;
      ctx.fillStyle = '#808080';
      ctx.fillRect(MARGIN_LEFT + (TEXT_WIDTH * p), 0, 1080, 1920);
    }
  } else {
    // Scene Isi
    ctx.fillStyle = "white";
    ctx.font = "700 54px 'PlusJakartaCustom'";
    let yBody = 1300;
    wrapText(bodyEl.value, TEXT_WIDTH).forEach(l => {
      ctx.fillText(l, MARGIN_LEFT, yBody);
      yBody += 70;
    });
  }
}

function animate(ts) {
  if (!animating && !recording) return;
  if (!animStart) animStart = ts;
  const elapsed = (ts - animStart) / 1000;
  drawFrame(elapsed);
  if (elapsed < targetDuration) requestAnimationFrame(animate);
  else { animating = false; statusEl.textContent = "Status: Idle"; }
}

document.getElementById('previewBtn').onclick = () => {
  titleTextureReady = false; animating = true; animStart = null; requestAnimationFrame(animate);
};

document.getElementById('renderBtn').onclick = () => {
  titleTextureReady = false; recording = true; animStart = null;
  const stream = canvas.captureStream(30);
  const recorder = new MediaRecorder(stream, { 
    mimeType: 'video/webm;codecs=vp9', videoBitsPerSecond: 8000000 
  });
  let chunks = [];
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    const blob = new Blob(chunks, { type: 'video/webm' });
    document.getElementById('download').innerHTML = `<a href="${URL.createObjectURL(blob)}" download="reels_1080p.webm" style="color:#38bdf8; font-weight:bold;">‚úÖ Download Video 1080p</a>`;
  };
  recorder.start();
  requestAnimationFrame(animate);
  setTimeout(() => { recorder.stop(); recording = false; }, targetDuration * 1000);
};
</script>
</body>
</html>
