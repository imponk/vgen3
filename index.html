<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Reels</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;}

body{
margin:0;
padding:12px;
display:flex;
gap:16px;
background:#020617;
color:#e5e7eb;
font-family:system-ui;
}

.panel{
background:#020617;
padding:16px;
border-radius:14px;
border:1px solid #1f2937;
}

.left{
width:380px;
}

canvas{
background:#808080;
border-radius:18px;
border:1px solid #4b5563;
height:90vh;
}

textarea{
width:100%;
margin-top:6px;
margin-bottom:10px;
background:#020617;
color:white;
border:1px solid #334155;
padding:8px;
border-radius:8px;
}

button{
padding:10px 18px;
margin-right:6px;
border:none;
border-radius:999px;
cursor:pointer;
}

.preview{
background:#111827;
color:white;
}

.render{
background:#2563eb;
color:white;
}

.status{
margin-top:10px;
font-size:13px;
color:#9ca3af;
}

.progress{
height:6px;
background:#1f2937;
margin-top:6px;
border-radius:999px;
overflow:hidden;
}

.bar{
height:100%;
width:0%;
background:#2563eb;
transition:width 0.2s;
}
</style>
</head>

<body>

<div class="panel left">

Upper
<textarea id="upper"></textarea>

Judul
<textarea id="title"></textarea>

Subjudul
<textarea id="subtitle"></textarea>

Isi
<textarea id="body"></textarea>

<button class="preview" id="previewBtn">
Preview
</button>

<button class="render" id="renderBtn">
Render MP4
</button>

<div class="status" id="status">
Idle
</div>

<div class="progress">
<div class="bar" id="bar"></div>
</div>

</div>

<canvas id="canvas" width="1080" height="1920"></canvas>

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>

<script>

const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

const previewBtn=document.getElementById("previewBtn");
const renderBtn=document.getElementById("renderBtn");

const statusEl=document.getElementById("status");
const bar=document.getElementById("bar");

const { createFFmpeg, fetchFile } = FFmpeg;

const ffmpeg=createFFmpeg({
log:false
});

let duration=8;
let animating=false;
let startTime=null;

function setStatus(text){
statusEl.textContent=text;
}

function setProgress(p){
bar.style.width=p+"%";
}

function drawFrame(t){

ctx.fillStyle="#808080";
ctx.fillRect(0,0,1080,1920);

ctx.fillStyle="white";
ctx.font="bold 80px sans-serif";
ctx.fillText("Preview / Render Test",100,1000);

ctx.font="40px sans-serif";
ctx.fillText("time: "+t.toFixed(2),100,1100);

}

function animate(ts){

if(!animating)return;

if(!startTime)startTime=ts;

let elapsed=(ts-startTime)/1000;

drawFrame(elapsed);

setProgress((elapsed/duration)*100);

if(elapsed<duration){

requestAnimationFrame(animate);

}else{

animating=false;
setStatus("Preview done");

}

}

previewBtn.onclick=()=>{

setStatus("Preview running...");
setProgress(0);

animating=true;
startTime=null;

requestAnimationFrame(animate);

};

async function convert(webmBlob){

setStatus("Loading encoder...");
setProgress(10);

if(!ffmpeg.loaded){

await ffmpeg.load();

}

setStatus("Encoding MP4...");
setProgress(40);

ffmpeg.FS("writeFile","in.webm",await fetchFile(webmBlob));

await ffmpeg.run(
"-i","in.webm",
"-c:v","libx264",
"-preset","ultrafast",
"-pix_fmt","yuv420p",
"out.mp4"
);

setProgress(90);

const data=ffmpeg.FS("readFile","out.mp4");

setProgress(100);

return new Blob([data.buffer],{type:"video/mp4"});
}

renderBtn.onclick=()=>{

setStatus("Recording...");
setProgress(0);

const stream=canvas.captureStream(30);

const rec=new MediaRecorder(stream,{
mimeType:"video/webm"
});

let chunks=[];

rec.ondataavailable=e=>chunks.push(e.data);

rec.onstop=async()=>{

const webmBlob=new Blob(chunks);

const mp4Blob=await convert(webmBlob);

const a=document.createElement("a");

a.href=URL.createObjectURL(mp4Blob);

a.download="reels.mp4";

a.click();

setStatus("Done");
};

rec.start();

animating=true;
startTime=null;

requestAnimationFrame(animate);

setTimeout(()=>rec.stop(),duration*1000);

};

drawFrame(0);

</script>

</body>
</html>
