<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Reels Renderer</title>

<style>

@font-face{
font-family:'DMSerifCustomBold';
src:url('./fonts/DMSerifDisplay-Bold.ttf') format('truetype');
font-weight:700;
}

@font-face{
font-family:'PlusJakartaCustom';
src:url('./fonts/PlusJakartaSans-Bold.woff2') format('woff2');
font-weight:700;
}

body{
background:#020617;
color:white;
font-family:'PlusJakartaCustom';
display:flex;
gap:20px;
padding:20px;
}

.panel{
width:380px;
}

textarea{
width:100%;
background:#020617;
color:white;
border:1px solid #334155;
padding:8px;
margin-bottom:8px;
}

button{
padding:8px 14px;
border-radius:999px;
border:none;
cursor:pointer;
}

.status{
margin-top:8px;
font-size:12px;
color:#94a3b8;
}

.progress{
height:6px;
background:#1f2937;
border-radius:999px;
overflow:hidden;
margin-top:4px;
}

.progress-bar{
height:100%;
width:0%;
background:#2563eb;
}

canvas{
background:#808080;
border-radius:16px;
}

</style>
</head>
<body>

<div class="panel">

Upper
<textarea id="upper"></textarea>

Judul
<textarea id="title"></textarea>

Subjudul
<textarea id="subtitle"></textarea>

Isi
<textarea id="body"></textarea>

<button id="previewBtn">Preview</button>
<button id="renderBtn">Render</button>

<div class="status" id="status">idle</div>
<div class="progress"><div class="progress-bar" id="progressBar"></div></div>

</div>

<canvas id="canvas" width="1080" height="1920"></canvas>

<script>

const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

const progressBar=document.getElementById("progressBar");
const statusEl=document.getElementById("status");

function setStatus(s){statusEl.textContent=s;}
function setProgress(p){progressBar.style.width=p+"%";}

const upperEl=document.getElementById("upper");
const titleEl=document.getElementById("title");
const subtitleEl=document.getElementById("subtitle");
const bodyEl=document.getElementById("body");

const previewBtn=document.getElementById("previewBtn");
const renderBtn=document.getElementById("renderBtn");

let titleCanvas;
let bodyPages=[];
let pageDurations=[];
let targetDuration=0;

let animStart=null;
let animating=false;

const TITLE_PRE_HOLD=0.3;
const TITLE_WIPE=0.8;
const TITLE_STATIC=2;

const PAGE_GAP=1;
const WORD_SPEED=3;

/* ---------- wrap ---------- */

function wrap(text,max,font){

ctx.font=font;

const words=text.split(" ");
let lines=[];
let line="";

words.forEach(w=>{

const test=line?line+" "+w:w;

if(ctx.measureText(test).width>max){

lines.push(line);
line=w;

}else line=test;

});

if(line)lines.push(line);

return lines;

}

/* ---------- build title ---------- */

function buildTitle(){

titleCanvas=document.createElement("canvas");
titleCanvas.width=1080;
titleCanvas.height=1920;

const t=titleCanvas.getContext("2d");

t.fillStyle="white";

let y=1220;

t.font="700 34px PlusJakartaCustom";

wrap(upperEl.value,860,t.font).forEach(l=>{
t.fillText(l,110,y);
y+=36;
});

y+=80;

t.font="700 90px DMSerifCustomBold";

wrap(titleEl.value,860,t.font).forEach(l=>{
t.fillText(l,110,y);
y+=90;
});

y-=20;

t.font="700 34px PlusJakartaCustom";

wrap(subtitleEl.value,860,t.font).forEach(l=>{
t.fillText(l,110,y);
y+=36;
});

}

/* ---------- highlight parser ---------- */

function parseHighlight(line){

const parts=[];
let i=0;

while(i<line.length){

if(line[i]=="["){

let j=line.indexOf("]",i);

parts.push({
text:line.substring(i+1,j),
highlight:true
});

i=j+1;

}else{

let j=line.indexOf("[",i);

if(j==-1)j=line.length;

parts.push({
text:line.substring(i,j),
highlight:false
});

i=j;

}

}

return parts;

}

/* ---------- draw body ---------- */

function drawBody(pageIndex,t){

ctx.fillStyle="#808080";
ctx.fillRect(0,0,1080,1920);

ctx.font="700 54px PlusJakartaCustom";

let y=1220;

const lines=bodyPages[pageIndex];

lines.forEach((line,i)=>{

let x=110;

const parts=parseHighlight(line);

parts.forEach(part=>{

if(part.highlight){

ctx.fillStyle="#2563eb";

}else{

ctx.fillStyle="white";

}

ctx.fillText(part.text,x,y);

x+=ctx.measureText(part.text).width;

});

y+=64;

});

}

/* ---------- title scene ---------- */

function drawTitle(t){

ctx.fillStyle="#808080";
ctx.fillRect(0,0,1080,1920);

if(t<TITLE_PRE_HOLD){

ctx.drawImage(titleCanvas,0,0);

return;
}

const wipeT=(t-TITLE_PRE_HOLD)/TITLE_WIPE;

const w=Math.min(1080,wipeT*1080);

ctx.save();

ctx.beginPath();
ctx.rect(0,0,w,1920);
ctx.clip();

ctx.drawImage(titleCanvas,0,0);

ctx.restore();

}

/* ---------- frame ---------- */

function drawFrame(t){

const titleTotal=TITLE_PRE_HOLD+TITLE_WIPE+TITLE_STATIC;

if(t<titleTotal){

drawTitle(t);
return;
}

let bt=t-titleTotal-PAGE_GAP;

let acc=0;

for(let i=0;i<bodyPages.length;i++){

if(bt<acc+pageDurations[i]){

drawBody(i,bt-acc);
return;

}

acc+=pageDurations[i]+PAGE_GAP;

}

}

/* ---------- compute ---------- */

function compute(){

buildTitle();

bodyPages=bodyEl.value.split("\n\n").map(p=>
wrap(p,860,"700 54px PlusJakartaCustom")
);

pageDurations=bodyPages.map(p=>
Math.max(4,p.join(" ").split(" ").length/WORD_SPEED)
);

targetDuration=
TITLE_PRE_HOLD+
TITLE_WIPE+
TITLE_STATIC+
pageDurations.reduce((a,b)=>a+b,0)+
PAGE_GAP*(bodyPages.length+1);

}

/* ---------- animate ---------- */

function animate(ts){

if(!animating)return;

if(!animStart)animStart=ts;

const t=(ts-animStart)/1000;

drawFrame(t);

setProgress(Math.min(100,t/targetDuration*100));

if(t<targetDuration){

requestAnimationFrame(animate);

}else{

animating=false;
setStatus("idle");

}

}

/* ---------- preview ---------- */

previewBtn.onclick=()=>{

compute();

setStatus("preview");

animStart=null;
animating=true;

requestAnimationFrame(animate);

};

/* ---------- render VP8 ---------- */

renderBtn.onclick=()=>{

compute();

setStatus("recording");

const stream=canvas.captureStream(30);

const rec=new MediaRecorder(stream,{
mimeType:"video/webm;codecs=vp8"
});

let chunks=[];

rec.ondataavailable=e=>chunks.push(e.data);

rec.onstop=()=>{

const blob=new Blob(chunks);

const a=document.createElement("a");

a.href=URL.createObjectURL(blob);
a.download="reels.webm";
a.click();

setStatus("done");

};

rec.start();

animStart=null;
animating=true;

requestAnimationFrame(animate);

setTimeout(()=>rec.stop(),targetDuration*1000+500);

};

compute();
drawFrame(0);

</script>

</body>
</html>
